name: Build and publish dist (Hostinger via FTP)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Instala dependências
      - name: Install deps (npm/yarn/pnpm)
        run: |
          set -e
          if [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm"
            corepack enable
            pnpm install --frozen-lockfile
            echo "BUILD_CMD=pnpm run build" >> $GITHUB_ENV
          elif [ -f yarn.lock ]; then
            echo "Using yarn"
            corepack enable
            yarn install --frozen-lockfile
            echo "BUILD_CMD=yarn build" >> $GITHUB_ENV
          else
            echo "Using npm"
            (npm ci || npm install)
            echo "BUILD_CMD=npm run build" >> $GITHUB_ENV
          fi

      - name: Build
        run: |
          echo "Running: $BUILD_CMD"
          eval "$BUILD_CMD"

      # Cria arquivo version.txt
      - name: Write version file
        run: echo "commit $GITHUB_SHA" > dist/version.txt

      # Debug: listar dist
      - name: Debug dist contents
        run: |
          echo "Conteúdo de dist/"
          ls -R dist

      # Deploy via FTP incremental
      - name: Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftp
          port: 21
          local-dir: ./dist/
          server-dir: public_html/
          exclude: |
            **/.git*
            **/node_modules/**
